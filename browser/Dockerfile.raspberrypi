ARG NODEJS_VERSION="12"

FROM balenalib/raspberrypi3:${NODEJS_VERSION}-run
RUN install_packages \
    git \
    gcc \
    make \
    libc6-dev \
    chromium-browser \
    rpi-chromium-mods \ 
    libgles2-mesa \
    lsb-release \
    mesa-vdpau-drivers \
    wget \
    x11-xserver-utils \
    xserver-xorg-input-evdev \
    xserver-xorg-legacy \
    xserver-xorg-video-fbdev \
    xserver-xorg xinit \
    xterm 

WORKDIR /usr/src/app

# install node dependencies
COPY ./package.json /usr/src/app/package.json
RUN JOBS=MAX npm install --unsafe-perm --production && npm cache clean --force

COPY ./src /usr/src/app/

RUN mkdir -p /etc/chromium/policies
RUN mkdir /etc/chromium/policies/managed
COPY ./policy.json /etc/chromium/policies/managed/my_policy.json

RUN chmod +x ./*.sh

ENV UDEV=1

# Add chromium user
RUN useradd chromium -m -s /bin/bash -G root || true && \
    groupadd -r -f chromium && id -u chromium || true \
    && chown -R chromium:chromium /home/chromium || true

COPY ./public-html /home/chromium  

# udev rule to set specific permissions 
RUN echo 'SUBSYSTEM=="vchiq",GROUP="video",MODE="0660"' > /etc/udev/rules.d/10-vchiq-permissions.rules
RUN usermod -a -G audio,video,tty chromium

# # Set up the audio block. This won't have any effect if the audio block is not being used.
RUN curl -skL https://raw.githubusercontent.com/balenablocks/audio/master/scripts/alsa-bridge/debian-setup.sh| sh
ENV PULSE_SERVER=tcp:audio:4317

COPY VERSION .

RUN git clone https://github.com/eskdale/pi-touchscreen-dimmer.git /usr/src/pi-touchscreen-dimmer
WORKDIR /usr/src/pi-touchscreen-dimmer
RUN make clean && make
WORKDIR /usr/src/app

# Start app
CMD ["bash", "/usr/src/app/start.sh"]
